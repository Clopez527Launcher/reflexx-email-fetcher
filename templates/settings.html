{% extends "base.html" %}
{% block title %}Settings – Reflexx{% endblock %}

{% block content %}
<style>
  /* ✅ Settings page cleanup */
  .page-wrapper, .page-wrapper * { color: #fff !important; }
  .muted { color: #cfe6ff !important; }
</style>

<div class="page-wrapper" style="max-width:1200px; margin:0 auto; padding:20px;">
  <h1 style="margin: 0 0 16px 0;">Settings</h1>

  <div class="card-dark" style="padding:16px; border-radius:12px;">
    <h3 style="margin:0 0 8px 0;">Daily Login Reminder Emails</h3>
    <p class="muted" style="margin:0 0 12px 0;">
      Toggle reminders ON/OFF for each user assigned to you.
    </p>

    <div id="usersList" class="muted">Loading users...</div>

    <div id="saveToast" class="muted" style="margin-top:10px; display:none;">
      Saved ✅
    </div>
  </div>
</div>

<script>
async function loadUsers() {
  const usersList = document.getElementById("usersList");

  const res = await fetch("/api/manager/users-email-reminders", { credentials: "include" });
  const data = await res.json();

  console.log("users-email-reminders GET:", data);
  console.log("first user:", data?.users?.[0]);

  if (!data || !Array.isArray(data.users)) {
    usersList.innerHTML = "Failed to load users ❌";
    return;
  }

  if (data.users.length === 0) {
    usersList.innerHTML = "No users found for your manager_id.";
    return;
  }

  const rowsHtml = data.users.map(u => {
    // ✅ use bracket notation (most defensive)
    const id = u["id"];
    const email = u["email"];
    const displayName = u["display_name"];
    const enabled = u["email_login_reminder_enabled"];

    const nameText = (displayName || email || ("User " + id));
    const checked = (enabled == 1) ? "checked" : "";

    return `
      <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid #1f2a36;">
        <div style="min-width:0;">
          <div style="font-weight:600;">${nameText}</div>
          <div class="muted" style="font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:520px;">
            ${email || ""}
          </div>
        </div>

        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
          <input
            type="checkbox"
            class="reminderToggle"
            data-user-id="${id}"
            ${checked}
            style="transform:scale(1.2);"
          />
          <span>Reminder</span>
        </label>
      </div>
    `;
  }).join("");

  usersList.innerHTML = rowsHtml;

  document.querySelectorAll(".reminderToggle").forEach(cb => {
    cb.addEventListener("change", async (e) => {
      const enabled = e.target.checked;

      // ✅ MOST IMPORTANT FIX: dataset read (avoids NaN/null issues)
      const userId = Number(e.target.dataset.userId);

      // If userId is bad, stop and show it
      if (!userId || Number.isNaN(userId)) {
        alert("Bad userId coming from checkbox: " + e.target.dataset.userId);
        e.target.checked = !enabled;
        return;
      }

      const r = await fetch("/api/manager/users-email-reminders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ user_id: userId, enabled: enabled })
      });

      // ✅ Read JSON even if 400 so we can SEE the error
      let out = {};
      try { out = await r.json(); } catch (err) {}

      if (!r.ok || !out.ok) {
        e.target.checked = !enabled; // revert
        alert("Save failed (" + r.status + "): " + JSON.stringify(out));
        return;
      }

      const toast = document.getElementById("saveToast");
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 1200);
    });
  });
}

document.addEventListener("DOMContentLoaded", loadUsers);
</script>
{% endblock %}

