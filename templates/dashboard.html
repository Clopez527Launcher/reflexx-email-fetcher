<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <style>
    /* RESET / GLOBAL STYLES */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
	  font-family: Arial, sans-serif;
	  background-color: #1f1f1f;
	  color: #fff;
	  display: flex;
	  flex-direction: column;
	  min-height: 100vh;
	  overflow-x: hidden;
	}
    /* TOP BANNER */
    .top-banner {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      width: 100%;
      height: 50px;
      background-color: #000000;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
    }
    .top-banner img {
      height: 40px;
    }
    /* SIDEBAR */
    .sidebar {
      position: fixed;
      top: 50px;
      left: 0;
      height: calc(100vh - 50px);
      overflow-y: auto;
      width: 170px;
      min-width: 170px;
      background-color: #000000;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding-top: 10px;
    }
    .sidebar h2 {
	  color: #00c8d7;
	  margin-bottom: 10px;
	  font-size: 1.2em;
	  white-space: nowrap;
	  text-align: center;
	  width: 100%;
	}
    .sidebar a {
	  display: block;
	  width: calc(100% - 30px); /* Creates left/right margin */
	  margin: 8px auto;
	  padding: 8px;
	  background-color: #333;
	  color: #fff;
	  border-radius: 5px;
	  font-weight: bold;
	  font-size: 0.9em;
	  text-align: center;
	  text-decoration: none;
	}
    .sidebar a:hover {
	  background-color: #00c8d7;
	  color: white;
	}
    .sidebar .active {
	  background-color: #00c8d7; /* Bright blue */
	  color: white;
	  box-shadow: 0 0 8px #00c8d7;
	}
    /* MAIN CONTENT */
    .main-content {
      margin-left: 180px;
      margin-top: 60px;
      flex: 1;
      padding: 20px;
      min-width: 600px;
      overflow-x: auto;
    }
    .top-bar h1 {
      color: #00c8d7;
      font-size: 1.5em;
      white-space: nowrap;
      margin-bottom: 10px;
    }
    /* DASHBOARD WIDGETS */
	.dashboard-widgets {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
		gap: 20px;
		margin-top: 20px;
	}

	/* üåü Widget Styling with Neon Glow */
	.widget {
		background-color: #2c2c2c;
		padding: 15px;
		border-radius: 8px;
		text-align: center;
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		min-width: 0;
		max-width: 100%;
		word-break: break-word;
		box-shadow: 0px 0px 10px rgba(0, 230, 230, 0.8); /* üîπ Blue-Turquoise Glow */
		transition: box-shadow 0.5s ease-in-out;
	}

	/* ‚úÖ Pulse Effect (Now Correctly Matches the Blue-Turquoise Theme) */
	@keyframes glowPulse {
		0% { box-shadow: 0px 0px 10px rgba(0, 230, 230, 0.5); }
		50% { box-shadow: 0px 0px 18px rgba(0, 230, 230, 1); }
		100% { box-shadow: 0px 0px 10px rgba(0, 230, 230, 0.5); }
	}

	.widget:hover {
		animation: glowPulse 3s infinite alternate;
	}

	/* ‚úÖ Text Color Tweaks for Better Contrast */
	.widget h3 {
		color: #00e6e6;
		margin-bottom: 10px;
		text-shadow: 0px 0px 10px rgba(0, 230, 230, 0.7); /* üîπ Now this glow matches too */
	}
	.widget p {
    font-size: clamp(2rem, 5vw, 4rem); /* Min: 2rem, Max: 4rem, adjusts based on viewport width */
    font-weight: bold;
    text-align: center;
    overflow: hidden;
    white-space: nowrap;
    }
    /* RANGE SELECTOR */
    .widget select {
      margin-top: 10px;
      padding: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
	  font-weight: bold;
    }
	.daily-average {
      color: #aaa !important; /* ‚úÖ Dark Gray */
      font-size: 1em !important;
	  font-weight: normal !important;
      margin-top: 5px !important;
    }
	.large-number {
    font-size: clamp(1.5rem, 4vw, 2.5rem) !important; /* Shrink more aggressively */
    font-weight: bold;
    text-align: center;
    display: flex;
    justify-content: center;
    align-items: center;
    max-width: 100%;
    overflow: hidden;
    white-space: nowrap;
    word-break: break-word;
    }
  </style>
</head>
<body>
  <!-- TOP BANNER -->
  <div class="top-banner">
    <img src="{{ url_for('static', filename='reflexx_logo.png') }}" alt="Reflexx Logo">
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar" style="display: flex; flex-direction: column; justify-content: space-between;">
    <!-- TOP NAV LINKS -->
    <div>
      <h2>Reflexx</h2>
      <a href="{{ url_for('dashboard') }}" class="active">Dashboard</a>
      <a href="{{ url_for('general_logs') }}">General Logs</a>
      <a href="{{ url_for('weblogs') }}">Web Logs</a>
      <a href="{{ url_for('download_tracker') }}">Download Tracker</a>
    </div>

    <!-- BOTTOM LINK: Logout -->
    <div>
      <a href="{{ url_for('logout') }}" 
         style="background-color: red; color: white; display: block; 
                text-align: center; padding: 10px; border-radius: 6px; 
                font-weight: bold; width: calc(100% - 30px); margin: 10px auto;">
        Logout
      </a>
    </div>
  </div> <!-- ‚úÖ Close sidebar -->

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <div class="top-bar">
      <h1>Dashboard</h1>
    </div>

    <p>Welcome! Here are your latest insights:</p>

    <div class="dashboard-widgets">
		<!-- ‚úÖ Web Logs Widget -->
		<div class="widget" style="grid-column: span 2; height: 350px;
			 display: flex; flex-direction: column; justify-content: flex-start;
			 align-items: center; position: relative;">
		  
		  <!-- ‚úÖ Dropdown (Positioned Top-Right) -->
		  <select id="weblogs-range-selector" style="position: absolute; top: 10px; right: 10px; 
				  padding: 5px; border-radius: 4px; background-color: #007bff; 
				  color: white; border: none; font-weight: bold;">
			<option value="today" selected>Today</option>
			<option value="yesterday">Yesterday</option>
			<option value="past_week">Past Week</option>
			<option value="past_month">Past Month</option>
			<option value="past_quarter">Past Quarter</option>
			<option value="past_year">Past Year</option>
		  </select>

		  <h3>Web Usage %</h3>

		  <!-- ‚úÖ Chart Container -->
		  <div style="width: 100%; height: 250px; display: flex; justify-content: center; align-items: center;">
			<canvas id="weblogsChart"></canvas>
		  </div>
		</div> <!-- ‚úÖ Closing .widget div -->

    <!-- ‚úÖ Total Mouse Distance Widget -->
    <div class="widget">
        <h3>Mouse Distance</h3>
        <p id="mouse-distance" class="large-number">üîÑ Loading...</p>
        <p id="mouse-distance-daily" class="daily-average">üîÑ Loading...</p>
        <select id="range-selector">
            <option value="today" selected>Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="past_week">Past Week</option>
            <option value="past_month">Past Month</option>
            <option value="past_quarter">Past Quarter</option>
            <option value="past_year">Past Year</option>
        </select>
    </div>

    <!-- ‚úÖ Total Keystrokes Widget -->
    <div class="widget">
        <h3>Keystrokes</h3>
        <p id="keystrokes-count" class="large-number">üîÑ Loading...</p>
        <p id="keystrokes-daily" class="daily-average">üîÑ Loading...</p>
        <select id="keystrokes-range-selector">
            <option value="today" selected>Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="past_week">Past Week</option>
            <option value="past_month">Past Month</option>
            <option value="past_quarter">Past Quarter</option>
            <option value="past_year">Past Year</option>
        </select>
    </div>

    <!-- ‚úÖ Total Mouse Clicks Widget -->
    <div class="widget">
        <h3>Clicks</h3>
        <p id="mouse-clicks" class="large-number">üîÑ Loading...</p>
        <p id="mouse-clicks-daily" class="daily-average">üîÑ Loading...</p>
        <select id="mouse-clicks-range-selector">
            <option value="today" selected>Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="past_week">Past Week</option>
            <option value="past_month">Past Month</option>
            <option value="past_quarter">Past Quarter</option>
            <option value="past_year">Past Year</option>
        </select>
    </div>

    <!-- ‚úÖ Total Idle Count Widget -->
    <div class="widget">
        <h3>Idle Count</h3>
        <p id="idle-count" class="large-number">üîÑ Loading...</p>
        <p id="idle-count-daily" class="daily-average">üîÑ Loading...</p>
        <select id="idle-count-range-selector">
            <option value="today" selected>Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="past_week">Past Week</option>
            <option value="past_month">Past Month</option>
            <option value="past_quarter">Past Quarter</option>
            <option value="past_year">Past Year</option>
        </select>
    </div>
</div> <!-- ‚úÖ Corrected: Closing div for dashboard-widgets goes here -->

  <script>
    function formatNumber(num) {
        return parseFloat(num).toLocaleString("en-US"); // Ensures proper number formatting
    }

    function fetchMouseDistance() {
        const userId = "{{ user_id }}" || localStorage.getItem("user_id");
        const range = document.getElementById("range-selector").value;

        let url = `/api/mouse_distance?user_id=${userId}&range=${range}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.total_mouse_distance !== undefined) {
                    document.getElementById("mouse-distance").innerText = formatNumber(Math.round(data.total_mouse_distance));
                } else {
                    document.getElementById("mouse-distance").innerText = "No Data";
                }

                if (data.daily_average_30 !== undefined) {
                    document.getElementById("mouse-distance-daily").innerText = `Daily Avg (30): ${formatNumber(Math.round(data.daily_average_30))}`;
                } else {
                    document.getElementById("mouse-distance-daily").innerText = "No Data";
                }
            })
            .catch(error => console.error("Error fetching mouse distance:", error));
    }

    function fetchKeystrokes() {
        const userId = "{{ user_id }}" || localStorage.getItem("user_id");
        const range = document.getElementById("keystrokes-range-selector").value;

        let url = `/api/keystrokes?user_id=${userId}&range=${range}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.total_keystrokes !== undefined) {
                    document.getElementById("keystrokes-count").innerText = formatNumber(data.total_keystrokes);
                } else {
                    document.getElementById("keystrokes-count").innerText = "No Data";
                }

                if (data.daily_average_30 !== undefined) {
                    document.getElementById("keystrokes-daily").innerText = `Daily Avg: ${formatNumber(data.daily_average_30)}`;
                } else {
                    document.getElementById("keystrokes-daily").innerText = "No Data";
                }
            })
            .catch(error => console.error("Error fetching keystrokes:", error));
    }

    function fetchMouseClicks() {
        const userId = "{{ user_id }}" || localStorage.getItem("user_id");
        const range = document.getElementById("mouse-clicks-range-selector").value;

        let url = `/api/mouse_clicks?user_id=${userId}&range=${range}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.total_mouse_clicks !== undefined) {
                    document.getElementById("mouse-clicks").innerText = formatNumber(data.total_mouse_clicks);
                } else {
                    document.getElementById("mouse-clicks").innerText = "No Data";
                }

                if (data.daily_average_30 !== undefined) {
                    document.getElementById("mouse-clicks-daily").innerText = `Daily Avg: ${formatNumber(data.daily_average_30)}`;
                } else {
                    document.getElementById("mouse-clicks-daily").innerText = "No Data";
                }
            })
            .catch(error => console.error("Error fetching mouse clicks:", error));
    }

    function formatTime(seconds) {
        let hours = Math.floor(seconds / 3600);
        let minutes = Math.floor((seconds % 3600) / 60);
        let secs = Math.round(seconds % 60);

        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function fetchIdleCount() {
        const userId = "{{ user_id }}" || localStorage.getItem("user_id");
        const range = document.getElementById("idle-count-range-selector").value;

        let url = `/api/idle_count?user_id=${userId}&range=${range}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.total_idle_count !== undefined) {
                    document.getElementById("idle-count").innerText = formatTime(data.total_idle_count);
                } else {
                    document.getElementById("idle-count").innerText = "No Data";
                }

                if (data.daily_average_30 !== undefined) {
                    document.getElementById("idle-count-daily").innerText = `Daily Avg: ${formatTime(data.daily_average_30)}`;
                } else {
                    document.getElementById("idle-count-daily").innerText = "No Data";
                }
            })
            .catch(error => console.error("Error fetching idle count:", error));
    }
    
	document.addEventListener("DOMContentLoaded", function () {
		const canvas = document.getElementById("weblogsChart");
		const rangeSelector = document.getElementById("weblogs-range-selector");

		if (!canvas || !rangeSelector) {
			console.error("‚ùå Missing critical elements: canvas or dropdown.");
			return;
		}

		const ctx = canvas.getContext("2d");
		let chart;

		async function fetchData(range = "today") {
			const userId = "{{ user_id }}" || localStorage.getItem("user_id");
			let url = `/api/weblogs_usage?user_id=${userId}&range=${range}`;

			try {
				const response = await fetch(url);
				const jsonData = await response.json();

				if (!jsonData || !jsonData.data) {
					console.warn("‚ö†Ô∏è No valid data received for web logs usage.");
					return null;
				}
				return jsonData.data; // ‚úÖ FIX: Access `data` key
			} catch (error) {
				console.error("‚ùå Error fetching web logs usage:", error);
				return null;
			}
		}

		// ‚úÖ Function to create a gradient-based color scale
		function generateGradient(ctx, chartArea) {
			let gradient = ctx.createLinearGradient(chartArea.left, 0, chartArea.right, 0);
			gradient.addColorStop(0, "rgba(0, 255, 150, 1)");   // Green at 0%
			gradient.addColorStop(0.15, "rgba(0, 200, 200, 1)"); // Cyan at 15%
			gradient.addColorStop(1, "rgba(0, 100, 255, 1)");   // Blue at 100%
			return gradient;
		}

		async function updateChart(range) {
			const data = await fetchData(range);

			if (!data) {
				console.error("‚ùå No data received, chart not updating.");
				return;
			}

			console.log("‚úÖ Web Logs Data:", data); // Debugging

			const labels = data.labels;
			const percentages = data.percentages;
			const times = data.times;

			// ‚úÖ Check if ALL percentages are 0 or missing
			const isEmptyData = percentages.every(value => value === 0 || value === null || value === undefined);

			// ‚úÖ Destroy previous chart if exists
			if (window.webLogsChart instanceof Chart) {
				window.webLogsChart.destroy();
			}

			const ctx = document.getElementById("weblogsChart").getContext("2d");

			if (isEmptyData) {
				console.warn("‚ö†Ô∏è No valid data available for this time range.");

				// ‚úÖ Display empty chart with "No Data Available" message
				window.webLogsChart = new Chart(ctx, {
					type: "bar",
					data: {
						labels: ["No Data Available"], // Show a single "No Data" label
						datasets: [{
							label: "Web Logs Usage (%)",
							data: [0], // No bars
							backgroundColor: "rgba(255, 255, 255, 0.2)",
							borderColor: "rgba(255, 255, 255, 0.2)",
							borderWidth: 1,
						}],
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						indexAxis: 'y',
						scales: {
							x: {
								beginAtZero: true,
								max: 100,
								ticks: { color: "white" },
							},
							y: {
								ticks: { color: "white" },
							},
						},
						plugins: {
							legend: { display: false },  // ‚úÖ Hide legend (removes the label & blue square)
							tooltip: { enabled: false }, // Hide tooltips on empty data
						},
					},
				});

			} else {
				// ‚úÖ Create a new chart with valid data
				window.webLogsChart = new Chart(ctx, {
					type: "bar",
					data: {
						labels: labels,
						datasets: [{
							label: "Web Logs Usage (%)",
							data: percentages,
							backgroundColor: function(context) {
								const chart = context.chart;
								const { ctx, chartArea } = chart;
								if (!chartArea || chartArea.width === 0 || chartArea.height === 0) {
									return "rgba(0, 255, 150, 1)";  // ‚úÖ Prevents errors if chart hasn't fully rendered yet
								}
								return generateGradient(ctx, chartArea);
							},
							borderColor: "#00bdbd",
							borderWidth: 1,
						}],
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						indexAxis: 'y',
						scales: {
							x: {
								beginAtZero: true,
								max: 100,
								ticks: { color: "white" },
							},
							y: {
								ticks: {
									color: "white",  // ‚úÖ Make labels bright white
									font: {
										weight: "bold",  // ‚úÖ Make them bold
										size: 14,        // ‚úÖ Slightly increase font size
									},
								},
							},
						},
						plugins: {
							legend: { display: false },  
							tooltip: {
								callbacks: {
									label: function (tooltipItem) {
										return ` ${tooltipItem.raw}% (${times[tooltipItem.dataIndex]})`;
									},
								},
							},
						},
					}
				});
			}
		}

		// ‚úÖ Safe Event Listener Function
		function safeAddListener(id, func) {
			const element = document.getElementById(id);
			if (element) {
				element.addEventListener("change", func);
			} else {
				console.warn(`‚ö†Ô∏è Element with id '${id}' not found.`);
			}
		}

		// ‚úÖ Attach Event Listeners Safely
		safeAddListener("weblogs-range-selector", function () {
			updateChart(this.value);
		});

		// ‚úÖ Load initial chart
		updateChart("today");

		// ‚úÖ Event Listeners for other widgets
		document.getElementById("range-selector")?.addEventListener("change", fetchMouseDistance);
		document.getElementById("keystrokes-range-selector")?.addEventListener("change", fetchKeystrokes);
		document.getElementById("mouse-clicks-range-selector")?.addEventListener("change", fetchMouseClicks);
		document.getElementById("idle-count-range-selector")?.addEventListener("change", fetchIdleCount);

		// ‚úÖ Fetch Data on Page Load
		fetchMouseDistance();
		fetchKeystrokes();
		fetchMouseClicks();
		fetchIdleCount();
	}); // <-- ‚úÖ Properly closes DOMContentLoaded event listener
	</script>
	</body>
	</html>



