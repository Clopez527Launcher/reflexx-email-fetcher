{% extends "base.html" %}

{% block title %}Graphs â€“ Reflexx{% endblock %}

{% block content %}

<!-- ======================= PAGE LAYOUT + POSITION FIXES ======================= -->
<style>
		/* Match Dashboard (New) background */
  body,
  .content,
  .content-wrapper,
  .page-wrapper {
      background: #12243b !important;  /* same as --page-navy on Dashboard */
      color: #e9f6ff;                  /* optional: match light text */
  }
  .analytics-page-wrapper {
    width: 100%;
    max-width: none;
    margin-left: 0;
    margin-right: 0;

    /* Push Analytics down to match Dashboard */
    padding-top: 0px;

    /* Match Dashboard horizontal position */
    padding-right: 26px;
    transform: translateX(-10px);

    box-sizing: border-box;
  }

  .analytics-h1 {
    color:#fff;
    text-align:left;
    padding-left: 6px;
    margin-top: 35px;
    margin-bottom: 16px;
    font-size: 32px;
    font-weight: 700;
  }

  .analytics-section {
    margin: 0;
    padding-left: 6px;
    padding-right: 0;
  }

  /* ================= Employee Trends widget styles ================= */
  .emp-card {
    background:#0e151d;
    border:1px solid #1f2a36;
    border-radius:12px;
    padding:16px;
    color:#e9f6ff;
    margin-top:18px;
  }

  .emp-controls {
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
  }

  .emp-controls h3 {
    margin:0;
    font-weight:700;
    flex:1 1 220px;
    text-align:center;
  }

  .emp-controls .right {
    margin-left:auto;
    display:flex;
    gap:10px;
    align-items:center;
  }

  .emp-input,
  .emp-select,
  .emp-btn {
    border:1px solid #1f2a36;
    background:#0e151d;
    color:#dff;
    border-radius:8px;
    padding:8px 10px;
  }

  .emp-btn { cursor:pointer; }

  .emp-grid {
    display:grid;
    grid-template-columns: repeat(2, minmax(260px, 1fr));
    gap:16px;
    margin-top:16px;
  }

		/* âœ… Team Index: make it truly fill the whole widget */
		#teamIndexTrends .team-grid {
				grid-template-columns: 1fr;
				height: 100%;
		}

		#teamIndexTrends .team-grid .emp-chart {
				grid-column: 1 / -1;
				height: 100%;
				min-height: 0;              /* IMPORTANT: allows flex to shrink/grow correctly */
				display: flex;
				flex-direction: column;
		}

		#teamIndexTrends .team-grid .emp-canvas-wrap {
				height: auto;               /* remove fixed height */
				flex: 1;                    /* take all remaining height */
				min-height: 0;              /* IMPORTANT */
		}

		/* âœ… Hide the old spacer tiles */
		#teamIndexTrends .team-grid .emp-chart[style*="visibility:hidden"] {
				display: none !important;
		}

  .emp-chart {
    background:#0b131a;
    border:1px solid #1f2a36;
    border-radius:10px;
    padding:12px;
    min-height:220px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }

  .emp-chart h4 {
    margin:0;
    font-size:16px;
    color:#cfe8ff;
  }

  .emp-canvas-wrap {
    position:relative;
    width:100%;
    height:180px;
  }
		
		/* =================== Widget grid layout =================== */
		.widgets-grid{
				display:grid;
				grid-template-columns: 1fr 1fr;
				gap:16px;
				align-items:stretch;                 /* âœ… equal heights per row */
		}

		/* âœ… Exact layout you want:
					Top left  = Phone
					Top right = Team Index
					Bottom left = Quotes
					Bottom right = Movement
		*/
		#phoneTrends     { grid-column:1; grid-row:1; }
		#teamIndexTrends { grid-column:2; grid-row:1; }
		#quoteTrends     { grid-column:1; grid-row:2; }
		#empTrends       { grid-column:2; grid-row:2; }

		/* =================== Make all widgets same height =================== */
		.emp-card{
				padding:12px;
				margin-top:0;                        /* âœ… grid controls spacing */
				height: 430px;                       /* âœ… one source of truth */
				display:flex;
				flex-direction:column;
				box-sizing:border-box;
		}

		/* Controls stay on top */
		.emp-controls{ flex:0 0 auto; }

		/* Grid area fills remaining space */
		.emp-grid{
				flex:1;
				min-height:0;                        /* âœ… critical */
				display:grid;
				grid-template-columns: repeat(2, minmax(260px, 1fr));
				gap:16px;
				margin-top:16px;
				align-content:stretch;
		}

		/* Chart tiles fill their grid cells */
		.emp-chart{
				min-height:0;                        /* âœ… critical */
				padding:10px;
				display:flex;
				flex-direction:column;
		}

		/* Canvas fills the tile */
		.emp-canvas-wrap{
				flex:1;
				min-height:0;                        /* âœ… critical */
				height:auto;                         /* âœ… remove fixed height */
		}

		/* =================== Team Index: fill the widget nicely =================== */
		/* Make its grid 1 column so the chart spans the full widget width */
		#teamIndexTrends .team-grid{
				grid-template-columns: 1fr;
		}

		/* Hide the 3 spacer tiles (no longer needed) */
		#teamIndexTrends .team-grid .emp-chart[style*="visibility:hidden"]{
				display:none !important;
		}

		/* =================== Mobile: stack everything =================== */
		@media (max-width: 980px){
				.widgets-grid{ grid-template-columns: 1fr; }

				#phoneTrends,
				#teamIndexTrends,
				#quoteTrends,
				#empTrends{
						grid-column:auto;
						grid-row:auto;
				}

				.emp-card{
						height:auto; /* âœ… natural height on mobile */
				}
		}

		/* ================= Date suggest: make the DATE INPUTS smaller ================= */
		.emp-input[type="date"]{
				-webkit-appearance: none;
				appearance: none;

				/* âœ… actual size of the field */
				height: 34px;              /* <-- makes it not massive */
				font-size: 13px;
				line-height: 34px;

				/* âœ… keep spacing tight */
				padding: 0 32px 0 10px;    /* right padding leaves room for icon */
		}

		/* ================= Date icon: small + white ================= */
		.emp-input[type="date"]::-webkit-calendar-picker-indicator{
				filter: invert(1) brightness(1.25);
				opacity: 0.95;
				cursor: pointer;

				width: 14px !important;
				height: 14px !important;

				padding: 0 !important;
				margin: 0 8px 0 0 !important;

				/* âœ… this is the secret sauce when browsers ignore width/height */
				transform: scale(0.85);
				transform-origin: center;
		}

		.emp-input[type="date"]:hover::-webkit-calendar-picker-indicator{
				opacity: 1;
		}


</style>

<!-- ======================= PAGE WRAPPER ======================= -->
<div class="analytics-page-wrapper">

  <h1 class="analytics-h1">Graphs</h1>

  <section class="analytics-section">
    <div class="widgets-grid">

      <!-- ======================= PHONE TRENDS ======================= -->
      <div id="phoneTrends" class="emp-card">
        <div class="emp-controls">
          <input id="phone-start" class="emp-input" type="date" />
          <input id="phone-end" class="emp-input" type="date" />

          <h3>Phone Trends</h3>

          <div class="right">
            <select id="phone-user" class="emp-select">
              <option value="">Loading employeesâ€¦</option>
            </select>
            <button id="phone-apply" class="emp-btn">Apply</button>
          </div>
        </div>

        <div class="emp-grid">
          <div class="emp-chart">
            <h4>Inbounds</h4>
            <div class="emp-canvas-wrap"><canvas id="phone-inbounds"></canvas></div>
          </div>

          <div class="emp-chart">
            <h4>Outbounds</h4>
            <div class="emp-canvas-wrap"><canvas id="phone-outbounds"></canvas></div>
          </div>

          <div class="emp-chart">
            <h4>IB Talk Time (min)</h4>
            <div class="emp-canvas-wrap"><canvas id="phone-ib-talk"></canvas></div>
          </div>

          <div class="emp-chart">
            <h4>OB Talk Time (min)</h4>
            <div class="emp-canvas-wrap"><canvas id="phone-ob-talk"></canvas></div>
          </div>
        </div>
      </div>

      <!-- ======================= QUOTING TRENDS ======================= -->
      <div id="quoteTrends" class="emp-card">
        <div class="emp-controls">
          <input id="quote-start" class="emp-input" type="date" />
          <input id="quote-end" class="emp-input" type="date" />

          <h3>Quoting Trends</h3>

          <div class="right">
            <select id="quote-user" class="emp-select">
              <option value="">Loading employeesâ€¦</option>
            </select>
            <button id="quote-apply" class="emp-btn">Apply</button>
          </div>
        </div>

        <div class="emp-grid">
          <div class="emp-chart">
            <h4>AdvisorPro Minutes</h4>
            <div class="emp-canvas-wrap"><canvas id="quote-ap-min"></canvas></div>
          </div>

          <div class="emp-chart">
            <h4>Quoted Items</h4>
            <div class="emp-canvas-wrap"><canvas id="quote-items"></canvas></div>
          </div>

          <div class="emp-chart">
            <h4>Quotes Unique</h4>
            <div class="emp-canvas-wrap"><canvas id="quote-unique"></canvas></div>
          </div>

          <!-- blank 4th tile so the grid stays aligned -->
          <div class="emp-chart" style="visibility:hidden;">
            <h4>Spacer</h4>
            <div class="emp-canvas-wrap"></div>
          </div>
        </div>
      </div>

      <!-- ======================= MOVEMENT TRENDS ======================= -->
      <div id="empTrends" class="emp-card">
        <div class="emp-controls">
          <input id="emp-start" class="emp-input" type="date" />
          <input id="emp-end" class="emp-input" type="date" />

          <h3>Movement Trends</h3>

          <div class="right">
            <select id="emp-user" class="emp-select">
              <option value="">Loading employeesâ€¦</option>
            </select>
            <button id="emp-apply" class="emp-btn">Apply</button>
          </div>
        </div>

        <div class="emp-grid">
          <div class="emp-chart">
            <h4>Mouse Distance</h4>
            <div class="emp-canvas-wrap"><canvas id="emp-mouse"></canvas></div>
          </div>

          <div class="emp-chart">
            <h4>Keystrokes</h4>
            <div class="emp-canvas-wrap"><canvas id="emp-keys"></canvas></div>
          </div>

          <div class="emp-chart">
            <h4>Clicks</h4>
            <div class="emp-canvas-wrap"><canvas id="emp-clicks"></canvas></div>
          </div>

          <div class="emp-chart">
            <h4>Idle Time</h4>
            <div class="emp-canvas-wrap"><canvas id="emp-idle"></canvas></div>
          </div>
        </div>
      </div>
						
					 <!-- ======================= TEAM INDEX TRENDS (NEW) ======================= -->
						<div id="teamIndexTrends" class="emp-card">
								<div class="emp-controls">
										<input id="team-start" class="emp-input" type="date" />
										<input id="team-end" class="emp-input" type="date" />

										<h3>Adjusted Team Index</h3>

										<div class="right">
												<button id="team-apply" class="emp-btn">Apply</button>
										</div>
								</div>

								<!-- âœ… Use same 2x2 grid as other widgets so height matches -->
								<div class="emp-grid team-grid">
										<div class="emp-chart">
												<h4>Elite Calls / Talk Time (per minute)</h4>
												<div class="emp-canvas-wrap"><canvas id="team-index"></canvas></div>
										</div>

										<!-- 3 spacers to match the 4-tile layout/height -->
										<div class="emp-chart" style="visibility:hidden;">
												<h4>Spacer</h4>
												<div class="emp-canvas-wrap"></div>
										</div>

										<div class="emp-chart" style="visibility:hidden;">
												<h4>Spacer</h4>
												<div class="emp-canvas-wrap"></div>
										</div>

										<div class="emp-chart" style="visibility:hidden;">
												<h4>Spacer</h4>
												<div class="emp-canvas-wrap"></div>
										</div>
								</div>
						</div>

    </div> <!-- /widgets-grid -->
  </section>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- ======================= EMPLOYEE TRENDS LOGIC (MOVEMENT + PHONE + QUOTING + TEAM INDEX) ======================= -->
<script>
(() => {
  const toYMD = (d) =>
    `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

  // ---------------------------
  // âœ… Movement controls
  // ---------------------------
  const startEl = document.getElementById('emp-start');
  const endEl   = document.getElementById('emp-end');
  const userSel = document.getElementById('emp-user');
  const apply   = document.getElementById('emp-apply');

  // ---------------------------
  // ðŸ“ž Phone controls
  // ---------------------------
  const pStartEl = document.getElementById('phone-start');
  const pEndEl   = document.getElementById('phone-end');
  const pUserSel = document.getElementById('phone-user');
  const pApply   = document.getElementById('phone-apply');

  // ---------------------------
  // ðŸ§¾ Quoting controls
  // ---------------------------
  const qStartEl = document.getElementById('quote-start');
  const qEndEl   = document.getElementById('quote-end');
  const qUserSel = document.getElementById('quote-user');
  const qApply   = document.getElementById('quote-apply');

  // ---------------------------
  // ðŸ§® Team Index controls (no user dropdown)
  // ---------------------------
  const tStartEl = document.getElementById('team-start');
  const tEndEl   = document.getElementById('team-end');
  const tApply   = document.getElementById('team-apply');

  // ---------------------------
  // âœ… Default dates
  // ---------------------------
  const today = new Date();
  endEl.value = toYMD(today);

  // âœ… Default to last 14 days (today + previous 13 days)
  startEl.value = toYMD(new Date(today.getTime() - 13*86400000));

  // Phone defaults match Movement
  pEndEl.value = endEl.value;
  pStartEl.value = startEl.value;

  // Quoting defaults match Movement
  qEndEl.value = endEl.value;
  qStartEl.value = startEl.value;

  // Team defaults match Movement
  tEndEl.value = endEl.value;
  tStartEl.value = startEl.value;

  // ---------------------------
		// ðŸ“ˆ Chart factory
		// ---------------------------
		const mkLine = (ctx, label) => new Chart(ctx, {
				type: 'line',
				data: {
						labels: [],
						datasets: [{
								label,
								data: [],
								tension: 0.35,
								pointRadius: 0,
								borderColor: '#00c0ff',
								backgroundColor: 'rgba(0,192,255,0.08)',
								fill: true
						}]
				},
				options: {
						responsive: true,
						maintainAspectRatio: false,

						// âœ… Makes hover MUCH easier (snap to nearest day)
						interaction: {
								mode: 'index',
								intersect: false,
								axis: 'x'
						},

						plugins: {
								legend: { display: false },
								tooltip: { enabled: true }
						},

						// âœ… Bigger invisible â€œhitboxâ€ for hovering
						elements: {
								point: {
										radius: 0,        // keep dots hidden
										hitRadius: 18,    // âœ… BIG hover area
										hoverRadius: 6    // little pop when hovering
								},
								line: { borderWidth: 2 }
						},

						scales: {
								x: {
										ticks: {
												color: '#9ab',
												callback(value) {
														const label = this.getLabelForValue(value);
														return /^\d{4}-\d{2}-\d{2}$/.test(label) ? label.slice(5) : label;
												}
										},
										grid: { color: '#1f2a36' }
								},
								y: {
										ticks: { color: '#9ab' },
										grid: { color: '#1f2a36' }
								}
						}
				}
		});


  // ---------------------------
  // âœ… Movement charts
  // ---------------------------
  const cMouse  = mkLine(document.getElementById('emp-mouse'),  'Mouse Distance');
  const cKeys   = mkLine(document.getElementById('emp-keys'),   'Keystrokes');
  const cClicks = mkLine(document.getElementById('emp-clicks'), 'Clicks');
  const cIdle   = mkLine(document.getElementById('emp-idle'),   'Idle');

  // ---------------------------
  // ðŸ“ž Phone charts
  // ---------------------------
  const cInbounds  = mkLine(document.getElementById('phone-inbounds'),  'Inbounds');
  const cOutbounds = mkLine(document.getElementById('phone-outbounds'), 'Outbounds');
  const cIbTalk    = mkLine(document.getElementById('phone-ib-talk'),   'IB Talk (min)');
  const cObTalk    = mkLine(document.getElementById('phone-ob-talk'),   'OB Talk (min)');

  // ---------------------------
  // ðŸ§¾ Quoting charts
  // ---------------------------
  const cApMin   = mkLine(document.getElementById('quote-ap-min'), 'AdvisorPro Minutes');
  const cQItems  = mkLine(document.getElementById('quote-items'),  'Quoted Items');
  const cQUnique = mkLine(document.getElementById('quote-unique'), 'Quotes Unique');

  // ---------------------------
  // ðŸ§® Team Index chart
  // ---------------------------
  const cTeamIndex = mkLine(document.getElementById('team-index'), 'Adjusted Team Index');

  // ---------------------------
  // ðŸŒ fetch helper
  // ---------------------------
  async function j(url){
    const r = await fetch(url, { credentials: 'same-origin' });

    // Read as text first so HTML error pages don't crash JSON parsing
    const text = await r.text();

    if (!r.ok) {
      console.error("API ERROR:", r.status, url, text.slice(0, 300));
      throw new Error(`API ${r.status}: ${url}`);
    }

    try {
      return JSON.parse(text);
    } catch (e) {
      console.error("API returned non-JSON:", url, text.slice(0, 300));
      throw e;
    }
  }

  // ---------------------------
  // ðŸ‘¥ Load employees into ALL dropdowns
  // ---------------------------
  async function loadEmployees(){
    try{
      const list = await j('/manager-employees');
      const pick = (u) => (u.nickname && u.nickname.trim()) || u.email;

      const options = list
        .sort((a,b)=>pick(a).localeCompare(pick(b)))
        .map(u => `<option value="${u.id}">${pick(u)}</option>`)
        .join('');

      userSel.innerHTML = options;
      pUserSel.innerHTML = options;
      qUserSel.innerHTML = options;

    }catch(e){
      userSel.innerHTML = `<option value="">(failed to load)</option>`;
      pUserSel.innerHTML = `<option value="">(failed to load)</option>`;
      qUserSel.innerHTML = `<option value="">(failed to load)</option>`;
      console.error(e);
    }
  }

  // Small helper to apply labels+data
  function setSeries(chart, labels, arr){
    chart.data.labels = labels;
    chart.data.datasets[0].data = arr || [];
    chart.update();
  }

  // ---------------------------
  // âœ… Refresh Movement
  // ---------------------------
  async function refreshMovement(){
    const uid = userSel.value;
    if(!uid) return;

    const s = startEl.value, e = endEl.value;

    try{
      const data = await j(`/api/analytics/employee-series?user_id=${uid}&start=${s}&end=${e}`);
      const L = data.labels || [];

      setSeries(cMouse,  L, data.mouse_distance);
      setSeries(cKeys,   L, data.keystrokes);
      setSeries(cClicks, L, data.mouse_clicks);
      setSeries(cIdle,   L, data.idle_count);

    }catch(e){
      console.error(e);
    }
  }

  // ---------------------------
  // ðŸ“ž Refresh Phone
  // ---------------------------
  async function refreshPhone(){
    const uid = pUserSel.value;
    if(!uid) return;

    const s = pStartEl.value, e = pEndEl.value;

    try{
      const data = await j(`/api/analytics/employee-phone-series?user_id=${uid}&start=${s}&end=${e}`);
      const L = data.labels || [];

      setSeries(cInbounds,  L, data.inbounds);
      setSeries(cOutbounds, L, data.outbounds);
      setSeries(cIbTalk,    L, data.ib_talk_minutes);
      setSeries(cObTalk,    L, data.ob_talk_minutes);

    }catch(e){
      console.error(e);
    }
  }

  // ---------------------------
  // ðŸ§¾ Refresh Quoting
  // ---------------------------
  async function refreshQuoting(){
    const uid = qUserSel.value;
    if(!uid) return;

    const s = qStartEl.value, e = qEndEl.value;

    try{
      const data = await j(`/api/analytics/employee-quote-series?user_id=${uid}&start=${s}&end=${e}`);
      const L = data.labels || [];

      setSeries(cApMin,   L, data.advisor_pro_minutes);
      setSeries(cQItems,  L, data.quoted_items);
      setSeries(cQUnique, L, data.quotes_unique);

    }catch(e){
      console.error(e);
    }
  }

  // ---------------------------
  // ðŸ§® Refresh Team Index
  // ---------------------------
  async function refreshTeamIndex(){
    const s = tStartEl.value, e = tEndEl.value;

    try{
      const data = await j(`/api/analytics/team-index-series?start=${s}&end=${e}`);
      const L = data.labels || [];

      setSeries(cTeamIndex, L, data.team_index);

    }catch(e){
      console.error(e);
    }
  }

  // ---------------------------
  // ðŸ–±ï¸ Apply buttons
  // ---------------------------
  apply.addEventListener('click', () => { refreshMovement(); refreshPhone(); refreshQuoting(); refreshTeamIndex(); });
  pApply.addEventListener('click', () => { refreshMovement(); refreshPhone(); refreshQuoting(); refreshTeamIndex(); });
  qApply.addEventListener('click', () => { refreshMovement(); refreshPhone(); refreshQuoting(); refreshTeamIndex(); });
  tApply.addEventListener('click', () => { refreshMovement(); refreshPhone(); refreshQuoting(); refreshTeamIndex(); });

  // ---------------------------
  // ðŸš€ Boot
  // ---------------------------
  loadEmployees().then(() => {
    refreshMovement();
    refreshPhone();
    refreshQuoting();
    refreshTeamIndex();
  });

})();
</script>

{% endblock %}
