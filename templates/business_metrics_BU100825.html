{% extends 'base.html' %}

{% block title %}Business Metrics – Reflexx{% endblock %}

{% block content %}
<style>
  /* ===== Analytics-style look & feel ===== */
  .with-sidebar { margin-left: 260px; padding: 16px 20px; }
  @media (max-width: 900px) { .with-sidebar { margin-left: 0; padding: 12px; } }

  .card-dark {
    background:#0e151d; border:1px solid #1f2a36; border-radius:12px;
    padding:16px; color:#e9f6ff;
  }
  .muted { color:#9ab; }
  .bm-section { max-width:1280px; margin:0 auto; }
  .bm-h1 { color:#fff; margin:0 0 12px; font-size:32px; font-weight:500; }
  .bm-h2 { color:#fff; margin:24px 0 12px; font-size:24px; font-weight:700; }

  /* Grid for the 3 metric cards */
  .bm-grid {
    display:grid;
    grid-template-columns: repeat(3, minmax(260px, 1fr));
    gap:16px;
  }
  @media (max-width: 1100px) { .bm-grid { grid-template-columns: repeat(2, minmax(260px, 1fr)); } }
  @media (max-width: 720px)  { .bm-grid { grid-template-columns: 1fr; } }

  .bm-card-title { margin:0 0 8px; font-size:16px; color:#cfe8ff; }
  .bm-legend { font-size:12px; color:#9ab; margin-bottom:6px; display:flex; align-items:center; gap:8px; }
  .bm-swatch { width:28px; height:10px; border:2px solid #00c0ff; border-radius:3px; display:inline-block; }
  .bm-canvas-wrap { position:relative; width:100%; height:220px; }
  /* make a card span the whole grid width (columns 1 → last) */
  .bm-span-all { grid-column: 1 / -1; }
  /* quotes pager buttons */
  .q-mini-btn {
    background:#0e151d; border:1px solid #2b3240; color:#e9f6ff;
    border-radius:8px; padding:6px 10px; cursor:pointer;
  }
  .q-mini-btn:disabled { opacity:.5; cursor:default; }

  /* Upload/history layout */
  .bm-upload .row { display:flex; gap:20px; align-items:flex-end; margin-bottom:10px; flex-wrap:wrap; }
  .bm-upload label { color:#fff; }
  .bm-upload select, .bm-upload input[type="file"] {
    border:1px solid #1f2a36; background:#0e151d; color:#dff; border-radius:8px; padding:6px 10px;
  }
  /* Replace plain cyan button with Analytics-style glow button */
  .bm-upload .glow-btn {
    background:#0e151d;
    color:#e9f6ff;
    border:1px solid #2b3240;
    border-radius:12px;
    padding:10px 20px;
    font-weight:700;
    cursor:pointer;
    box-shadow:
      0 0 0 0 rgba(138,92,255,.50),
      0 0 18px 2px rgba(138,92,255,.35) inset;
    transition:transform .1s ease, box-shadow .15s ease;
  }
  .bm-upload .glow-btn:hover {
    transform: translateY(-1px);
    box-shadow:
      0 0 22px 6px rgba(138,92,255,.45),
      0 0 18px 2px rgba(138,92,255,.45) inset;
  }

  /* Controls row mimics Analytics: left controls + centered button */
  .bm-controls {
    display:flex; align-items:center; gap:14px; flex-wrap:wrap; margin:10px 0 14px;
  }
  .bm-controls .left { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
  .bm-controls label { color:#cfe8ff; }
  .bm-controls .mid { flex:1; display:flex; justify-content:center; }
  .bm-upload select, .bm-upload input[type="file"] {
    border:1px solid #1f2a36; background:#0e151d; color:#dff; border-radius:8px; padding:6px 10px;
 }
</style>

<div class="with-sidebar">
  <section class="bm-section bm-upload">
    <h1 class="bm-h1">Business Metrics</h1>

    <form id="metricsForm" enctype="multipart/form-data" style="margin-top:10px;">
	  <div class="bm-controls">
		<div class="left">
		  <label>
			File:
			<input type="file" name="file" accept=".xlsx" required />
		  </label>

		  <label for="month">Month:
			<select name="month" id="month" required>
			  <option value="">Select Month</option>
			  {% set months = ['January','February','March','April','May','June','July','August','September','October','November','December'] %}
			  {% for m in months %}
				<option value="{{ loop.index }}">{{ m }}</option>
			  {% endfor %}
			</select>
		  </label>

		  <label for="year">Year:
			<select name="year" id="year" required>
			  {% for y in range(2024, 2031) %}
				<option value="{{ y }}">{{ y }}</option>
			  {% endfor %}
			</select>
		  </label>
		</div>

		<!-- Centered glow button like Analytics "Apply" -->
		<div class="mid">
		  <button type="submit" class="glow-btn">Upload Report</button>
		</div>

		<!-- right spacer (kept empty to mirror Analytics layout) -->
		<div style="width:1px;"></div>
	  </div>
	</form>

    <h2 class="bm-h2">Upload History</h2>
    <ul id="uploadHistory" style="max-height:300px; overflow-y:auto; padding-left:20px; color:white; list-style-type:disc;">
      <!-- JS will prepend history here -->
    </ul>

    <h2 class="bm-h2">Business Metric Trends</h2>
	<div class="bm-grid">
	  <!-- Net Retention -->
	  <div class="card-dark">
		<h4 class="bm-card-title">Net Retention</h4>
		<div class="bm-legend"><span class="bm-swatch"></span> Net Retention</div>
		<div class="bm-canvas-wrap"><canvas id="bm-net"></canvas></div>
	  </div>

	  <!-- W&A Premium -->
	  <div class="card-dark">
		<h4 class="bm-card-title">W&A Premium</h4>
		<div class="bm-legend"><span class="bm-swatch"></span> W&A Premium</div>
		<div class="bm-canvas-wrap"><canvas id="bm-wa"></canvas></div>
	  </div>

	  <!-- 12MM Loss Ratio -->
	  <div class="card-dark">
		<h4 class="bm-card-title">12MM Loss Ratio</h4>
		<div class="bm-legend"><span class="bm-swatch"></span> 12MM Loss Ratio</div>
		<div class="bm-canvas-wrap"><canvas id="bm-loss"></canvas></div>
	  </div>

	  <!-- Quotes Uploads (full row under the 3 charts) -->
	  <div class="card-dark bm-span-all" id="quotes-widget">
		<div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
		  <h4 class="bm-card-title" style="margin-right:auto;">Quotes Uploads</h4>
		  <input id="quotes-file" type="file" style="display:none;" />
		  <button id="quotes-upload-btn" class="glow-btn">Upload Quotes</button>
		</div>

		<div id="quotes-list" class="muted" style="margin-top:10px;">
		  <div style="font-size:14px; margin-bottom:6px;">Recent uploads</div>
		  <ul id="quotes-ul" style="margin:0; padding-left:16px; max-height:180px; overflow:auto;"></ul>
		  <div id="quotes-pager" style="display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px;">
		    <button id="quotes-prev" class="q-mini-btn" disabled>Prev</button>
		    <span id="quotes-page" class="muted">Page 1</span>
		    <button id="quotes-next" class="q-mini-btn" disabled>Next</button>
		  </div>
		</div>
	  </div>
	</div>

<!-- Chart.js (skip if already in base.html) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ===== Upload handler (Business Metrics report) =====
document.getElementById("metricsForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  const formData = new FormData(this);

  const res = await fetch("/api/upload-business-metrics", { method: "POST", body: formData });
  const result = await res.json();

  if (result.success) {
    const li = document.createElement("li");
    li.textContent = `${result.filename} – ${result.month}/${result.year}`;
    document.getElementById("uploadHistory").prepend(li);
    loadTrends();
  } else {
    alert("Error: " + result.error);
  }
});

// ===== Analytics-style chart factory =====
function mkAnalyticsLine(ctx, label, yTickFmt) {
  return new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{
      label,
      data: [],
      tension: 0.35,
      pointRadius: 2,
      borderColor: '#00c0ff',
      backgroundColor: 'rgba(0,192,255,0.10)',
      fill: true
    }]},
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { intersect: false, mode: 'index' }
      },
      scales: {
        x: {
          ticks: {
            color: '#9ab',
            maxRotation: 35,
            minRotation: 35,
            callback: function(v){
              const lbl = this.getLabelForValue(v);
              return (typeof lbl === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(lbl)) ? lbl.slice(5) : lbl; // MM-DD
            }
          },
          grid: { color: '#1f2a36' }
        },
        y: {
          ticks: { color: '#9ab', callback: yTickFmt || (v => v) },
          grid: { color: '#1f2a36' }
        }
      }
    }
  });
}

// Pretty formatters
const fmtPct = v => (typeof v === 'number' ? Math.round(v) + '%' : v);
const usdCompact = new Intl.NumberFormat('en-US', {
  style:'currency', currency:'USD', notation:'compact', maximumFractionDigits:1
}).format;

// ===== Create charts =====
const netChart  = mkAnalyticsLine(document.getElementById('bm-net').getContext('2d'),  'Net Retention', fmtPct);
const waChart   = mkAnalyticsLine(document.getElementById('bm-wa').getContext('2d'),   'W&A Premium',  v => usdCompact(v));
const lossChart = mkAnalyticsLine(document.getElementById('bm-loss').getContext('2d'), '12MM Loss Ratio', fmtPct);

// ===== Data loader =====
async function loadTrends() {
  const res = await fetch("/api/metrics-trend");
  const data = await res.json();

  if (data["Net Retention"]) {
    netChart.data.labels = data["Net Retention"].labels || [];
    netChart.data.datasets[0].data = data["Net Retention"].values || [];
    netChart.update();
  }
  if (data["W&A Premium"]) {
    waChart.data.labels = data["W&A Premium"].labels || [];
    waChart.data.datasets[0].data = data["W&A Premium"].values || [];
    waChart.update();
  }
  if (data["12MM Loss Ratio"]) {
    lossChart.data.labels = data["12MM Loss Ratio"].labels || [];
    lossChart.data.datasets[0].data = data["12MM Loss Ratio"].values || [];
    lossChart.update();
  }
}

// ===== Quotes widget logic =====
let QUOTES_PAGE = 1;

async function refreshQuotes(page = QUOTES_PAGE) {
  QUOTES_PAGE = page;

  try {
    const r = await fetch(`/api/quotes/list?page=${page}`, { credentials: "same-origin" });
    const j = await r.json();

    const ul = document.getElementById("quotes-ul");
    if (!ul) return;
    ul.innerHTML = "";

    const fmtPT = new Intl.DateTimeFormat("en-US", {
      timeZone: "America/Los_Angeles",
      year: "numeric", month: "short", day: "2-digit",
      hour: "2-digit", minute: "2-digit"
    });

    (j.items || []).forEach(it => {
      const whenDate = it.uploaded_at ? new Date(it.uploaded_at) : null;
      const when = (whenDate && !isNaN(whenDate)) ? fmtPT.format(whenDate) : "—";
      const kb = Math.round((Number(it.file_size) || 0) / 1024);

      const li = document.createElement("li");
      li.style.margin = "4px 0";

      const a = document.createElement("a");
      a.href = `/quotes/view/${it.id}`;
      a.textContent = `${it.original_name} — ${when} (${kb} KB)`;
      a.target = "_blank";
      a.style.color = "#a8c7ff";

      li.appendChild(a);
      ul.appendChild(li);
    });

    if (!j.items || j.items.length === 0) {
      ul.innerHTML = "<li>No uploads yet.</li>";
    }

    // pager
    const prevBtn = document.getElementById("quotes-prev");
    const nextBtn = document.getElementById("quotes-next");
    const pageLbl = document.getElementById("quotes-page");

    if (pageLbl) pageLbl.textContent = `Page ${j.page} of ${j.total_pages}`;
    if (prevBtn) {
      prevBtn.disabled = (j.page <= 1);
      prevBtn.onclick = () => refreshQuotes(j.page - 1);
    }
    if (nextBtn) {
      nextBtn.disabled = (j.page >= j.total_pages);
      nextBtn.onclick = () => refreshQuotes(j.page + 1);
    }
  } catch (e) {
    console.error(e);
  }
}

// Setup quotes upload button + file input
(function setupQuotesWidget(){
  const btn  = document.getElementById("quotes-upload-btn");
  const file = document.getElementById("quotes-file");
  if (!btn || !file) return;

  btn.addEventListener("click", () => file.click());
  file.addEventListener("change", async () => {
    if (!file.files || !file.files[0]) return;
    const fd = new FormData();
    fd.append("file", file.files[0]);
    try {
      const r = await fetch("/api/quotes/upload", { method: "POST", body: fd, credentials: "same-origin" });
      const j = await r.json();
      if (j.success) {
        file.value = "";
        await refreshQuotes(1); // back to page 1 after upload
      } else {
        alert(j.error || "Upload failed");
      }
    } catch (e) {
      console.error(e);
      alert("Upload failed");
    }
  });
})();

// Kick everything off after DOM is ready
window.addEventListener("DOMContentLoaded", () => {
  loadTrends();
  refreshQuotes(1);
});
</script>

{% endblock %}