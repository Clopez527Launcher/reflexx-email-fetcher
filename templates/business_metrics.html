{% extends 'base.html' %}

{% block title %}Business Metrics â€“ Reflexx{% endblock %}

{% block content %}

<style>
  /* =========================================================
     Uploads / Business Metrics â€” layout only
     âœ… No forced widget colors (base.html controls cards + dropdowns)
     ========================================================= */

  /* Top spacing like Analytics/Dashboard */
  .page-wrapper{
    margin-top: 0 !important;
    padding-top: 28px !important;
  }

  /* Keep section aligned with Dashboard */
  .bm-section{
    margin: 0;
    padding-left: 6px;
    padding-right: 0;
  }

  /* Title spacing */
  .bm-h1{
    margin: 0 0 12px 0;
    font-size: 32px;
    font-weight: 600;
  }

  /* Header row: title left, controls right */
  .bm-header-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:16px;
    flex-wrap:wrap;
    margin: 0 0 14px 0;
  }

  .bm-h2{
    margin: 0;
    font-size: 22px;
    font-weight: 700;
  }

  /* Controls area */
  .bm-controls{
    display:flex;
    align-items:center;
    gap:14px;
    flex-wrap:wrap;
    margin:0;
    justify-content:flex-end;
  }

  /* Step columns inside the form */
  .bm-steps{
    display:grid;
    grid-template-columns: auto auto auto;
    align-items:center;
    column-gap: 22px;
    row-gap: 10px;
  }

  .bm-step{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
  }

  .bm-step-top{
    display:flex;
    align-items:center;
    gap:10px;
    white-space:nowrap;
  }

  .bm-help{
    font-size:12px;
    opacity:0.8; /* base.html colors will show through */
  }

  /* âœ… Charts/cards grid */
  .bm-grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(260px, 1fr));
    gap: 16px;
  }

  @media (max-width: 1100px){
    .bm-grid{ grid-template-columns: repeat(2, minmax(260px, 1fr)); }
    .bm-steps{ grid-template-columns: 1fr; justify-items:start; }
    .bm-step{ align-items:flex-start; }
  }

  @media (max-width: 720px){
    .bm-grid{ grid-template-columns: 1fr; }
  }

  .bm-span-all{ grid-column: 1 / -1; }

  /* Chart canvas sizing */
  .bm-canvas-wrap{
    position: relative;
    width: 100%;
    height: 180px;
  }

  /* Minor text helpers (no color forcing) */
  .bm-card-title{
    margin: 0 0 8px;
    font-size: 16px;
    font-weight: 700;
  }

  .bm-legend{
    font-size: 12px;
    margin-bottom: 6px;
    display:flex;
    align-items:center;
    gap:8px;
    opacity: 0.8;
  }

  .bm-swatch{
    width: 28px;
    height: 10px;
    border: 2px solid currentColor; /* inherits base text color */
    border-radius: 3px;
    display:inline-block;
    opacity: 0.8;
  }

  /* âœ… Make file input not explode the layout */
  input[type="file"]{
    max-width: 260px;
  }

  /* âœ… Pager row layout only */
  .bm-pager{
    display:flex;
    gap:6px;
    align-items:center;
    justify-content:flex-end;
    margin-top:8px;
  }

  /* âœ… Remove ONLY if some other CSS hides these */
  #uploadHistory{ display:none; }
</style>

<div class="page-wrapper">
  <h1 class="bm-h1">Uploads</h1>

  <section class="bm-section bm-upload">

    <!-- ========================= -->
    <!-- Header widget (base.html card) -->
    <!-- ========================= -->
    <div class="widget-card" style="padding:16px 18px; border-radius:14px; margin-top:10px;">
      <div class="bm-header-row">

        <h2 class="bm-h2">Business Metric Trends</h2>

        <form id="metricsForm" enctype="multipart/form-data" style="margin:0;">
          <div class="bm-steps">

            <!-- STEP 1 -->
            <div class="bm-step">
              <div class="bm-step-top">
                <span>Business Metric File:</span>
                <input id="bm-file" type="file" name="file" accept=".xlsx" />
              </div>
              <div class="bm-help">Step 1: Choose file</div>
            </div>

            <!-- STEP 2 -->
            <div class="bm-step">
              <div class="bm-step-top">
                <span>Month:</span>
                <select name="month" id="bm-month" required>
                  <option value="">Select Month</option>
                  {% set months = ['January','February','March','April','May','June','July','August','September','October','November','December'] %}
                  {% for m in months %}
                    <option value="{{ loop.index }}">{{ m }}</option>
                  {% endfor %}
                </select>

                <span>Year:</span>
                <select name="year" id="bm-year" required>
                  {% for y in range(2024, 2031) %}
                    <option value="{{ y }}">{{ y }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="bm-help">Step 2: Select month + year</div>
            </div>

            <!-- STEP 3 -->
            <div class="bm-step">
              <!-- âœ… No custom button colors: let base.html style it -->
              <button id="bm-upload-btn" type="submit">Upload Report</button>
              <div class="bm-help">Step 3: Upload</div>
            </div>

          </div>

          <div id="bmStatus" style="margin-top:10px; font-size:13px; opacity:0.85;"></div>
        </form>

      </div>
    </div>

    <!-- kept for JS, hidden -->
    <ul id="uploadHistory"></ul>

    <!-- ========================= -->
    <!-- Business Metric Trends cards (base.html widget-card) -->
    <!-- ========================= -->
    <div class="bm-grid" style="margin-top:16px;">

      <div class="widget-card">
        <h4 class="bm-card-title">Net Retention</h4>
        <div class="bm-legend"><span class="bm-swatch"></span> Net Retention</div>
        <div class="bm-canvas-wrap"><canvas id="bm-net"></canvas></div>
      </div>

      <div class="widget-card">
        <h4 class="bm-card-title">W&amp;A Premium</h4>
        <div class="bm-legend"><span class="bm-swatch"></span> W&amp;A Premium</div>
        <div class="bm-canvas-wrap"><canvas id="bm-wa"></canvas></div>
      </div>

      <div class="widget-card">
        <h4 class="bm-card-title">12MM Loss Ratio</h4>
        <div class="bm-legend"><span class="bm-swatch"></span> 12MM Loss Ratio</div>
        <div class="bm-canvas-wrap"><canvas id="bm-loss"></canvas></div>
      </div>

      <!-- New Business Details -->
      <div class="widget-card bm-span-all" id="nb-widget">
        <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
          <h4 class="bm-card-title" style="margin-right:auto;">New Business Details</h4>

          <form id="nbDetailsForm" enctype="multipart/form-data" style="margin:0;">
            <input id="nb-file" type="file" name="file" accept=".xlsx" style="display:none;" required />
            <button type="button" id="nb-upload-btn">Upload</button>
          </form>
        </div>

        <div style="margin-top:10px; opacity:0.85;">
          <div style="font-size:14px; margin-bottom:6px;">Status</div>
          <div id="nbStatus" style="font-size:13px; margin-bottom:10px;">No NB upload yet.</div>

          <div style="font-size:14px; margin-bottom:6px;">Recent NB uploads</div>
          <ul id="nb-ul" style="margin:0; padding-left:16px; max-height:150px; overflow:auto;"></ul>

          <div id="nb-pager" class="bm-pager">
            <button id="nb-prev" disabled>&lt;</button>
            <span id="nb-page" style="opacity:0.85;">Page 1 of 1</span>
            <button id="nb-next" disabled>&gt;</button>
          </div>
        </div>
      </div>

      <!-- Quotes Uploads -->
      <div class="widget-card bm-span-all" id="quotes-widget">
        <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; justify-content:space-between; width:100%;">
          <h4 class="bm-card-title">Total Serious Quotes Detail</h4>
          <div>
            <input id="quotes-file" type="file" style="display:none;" />
            <button id="quotes-upload-btn">Upload</button>
          </div>
        </div>

        <div id="quotes-list" style="margin-top:10px; opacity:0.85;">
          <div style="font-size:14px; margin-bottom:6px;">Recent uploads</div>
          <ul id="quotes-ul" style="margin:0; padding-left:16px; max-height:180px; overflow:auto;"></ul>

          <div id="quotes-pager" class="bm-pager">
            <button id="quotes-prev" disabled>&lt;</button>
            <span id="quotes-page" style="opacity:0.85;">Page 1 of 1</span>
            <button id="quotes-next" disabled>&gt;</button>
          </div>
        </div>
      </div>

    </div>
  </section>
</div>


<script>
  // ============================================================
  // âœ… Business Metrics Upload UX:
  //    1) Select file
  //    2) Select month/year
  //    3) Click Upload
  // ============================================================
  (function setupBusinessMetricsUpload() {
    const form     = document.getElementById("metricsForm");
    const fileIn   = document.getElementById("bm-file");
    const monthSel = document.getElementById("bm-month");
    const yearSel  = document.getElementById("bm-year");
    const btn      = document.getElementById("bm-upload-btn");
    const statusEl = document.getElementById("bmStatus");

    if (!form || !fileIn || !monthSel || !yearSel || !btn) return;

    // helper: show friendly status
    function setStatus(msg) {
      if (statusEl) statusEl.textContent = msg;
    }

    // Stop browser from doing weird native validation flow
    form.setAttribute("novalidate", "novalidate");

    // On file choose, just confirm selected
    fileIn.addEventListener("change", () => {
      const f = fileIn.files && fileIn.files[0];
      if (f) setStatus(`âœ… File selected: ${f.name}. Now pick Month + Year, then click Upload.`);
      else setStatus("");
    });

    // Only upload when they click the Upload button (submit)
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const f = fileIn.files && fileIn.files[0];
      if (!f) { alert("Pick a file first."); fileIn.focus(); return; }

      const month = monthSel.value;
      if (!month) { alert("Pick a month."); monthSel.focus(); return; }

      const year = yearSel.value;
      if (!year) { alert("Pick a year."); yearSel.focus(); return; }

      const fd = new FormData();
      fd.append("file", f);
      fd.append("month", month);
      fd.append("year", year);

      setStatus("Uploading business metricsâ€¦");

      try {
        const res = await fetch("/api/upload-business-metrics", {
          method: "POST",
          body: fd,
          credentials: "same-origin",
          cache: "no-store"
        });

        const result = await res.json();

        if (!res.ok || !result.success) {
          const msg = "Upload failed: " + (result.error || "Unknown error");
          setStatus(msg);
          alert(msg);
          return;
        }

        setStatus(`âœ… Saved for ${month}/${year}. Refreshing chartsâ€¦`);

        // clear file so same file can be re-uploaded
        fileIn.value = "";

        // refresh charts right away (cache bust)
        if (typeof loadTrends === "function") {
          await loadTrends(true);
        }

        setStatus(`âœ… Upload complete for ${month}/${year}.`);

      } catch (err) {
        console.error(err);
        setStatus("Upload error.");
        alert("Upload error.");
      }
    });
  })();
</script>


<script>
  // ===== Upload handler (New Business Details / sales) =====
  (function setupNbDetailsUpload() {
    const form = document.getElementById("nbDetailsForm");
    if (!form) return;

    const fileInput = document.getElementById("nb-file");
    const btn       = document.getElementById("nb-upload-btn");

    // Click button -> open file picker
    if (btn && fileInput) {
      btn.addEventListener("click", () => fileInput.click());

      // When a file is chosen -> submit the form
      fileInput.addEventListener("change", () => {
        if (fileInput.files && fileInput.files[0]) {
          form.dispatchEvent(new Event("submit", { bubbles: true, cancelable: true }));
        }
      });
    }

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const statusEl = document.getElementById("nbStatus");
      if (statusEl) statusEl.textContent = "Uploadingâ€¦";

      try {
        const res = await fetch("/upload_nb_details", {
          method: "POST",
          body: formData
        });

        const result = await res.json();

        if (result.success) {
          if (statusEl) {
            statusEl.textContent = `Imported ${result.rows_inserted} rows into NB detail reports.`;
          }
          // refresh NB list after a good upload
          refreshNbUploads(1);
        } else {
          const msg = "Error: " + (result.error || "Upload failed");
          if (statusEl) statusEl.textContent = msg;
          alert(msg);
        }
      } catch (err) {
        console.error(err);
        if (statusEl) statusEl.textContent = "Error uploading file.";
        alert("Error uploading file.");
      }
    });
  })();

  // ===== Analytics-style chart factory =====
		function mkAnalyticsLine(ctx, label, yTickFmt) {
				return new Chart(ctx, {
						type: "line",
						data: {
								labels: [],
								datasets: [{
										label,
										data: [],
										tension: 0.35,
										pointRadius: 2,
										borderColor: "#00c0ff",
										backgroundColor: "#12243b",
										fill: true
								}]
						},
						options: {
								responsive: true,
								maintainAspectRatio: false,
								plugins: {
										legend: { display: false },
										tooltip: { intersect: false, mode: "index" }
								},
								scales: {
										x: {
												ticks: {
														color: "#9ab",
														maxRotation: 35,
														minRotation: 35,
														autoSkip: false,

														// âœ… Show every other month anchored to the MOST RECENT point:
														// Example: Nov, Sep, Jul, May, Mar, Jan
														callback: function (v) {
																const labels = this.chart?.data?.labels || [];
																const lbl = this.getLabelForValue(v);

																const lastIdx = labels.length - 1;
																if (lastIdx < 0) return "";

																// Distance from the end: 0=last, 1=one before last, etc.
																const distFromEnd = lastIdx - v;

																// âœ… show labels at dist 0,2,4,6... (every other month from the end)
																const show = (distFromEnd % 2 === 0);
																if (!show) return "";

																// format YYYY-MM-DD => MM-YY
																if (typeof lbl === "string" && /^\d{4}-\d{2}-\d{2}$/.test(lbl)) {
																		const yy = lbl.slice(2, 4);
																		const mm = lbl.slice(5, 7);
																		return `${mm}-${yy}`;
																}

																return lbl;
														}
												},
												grid: { color: "#1f2a36" }
										},
										y: {
												ticks: { color: "#9ab", callback: yTickFmt || (v => v) },
												grid: { color: "#1f2a36" }
										}
								}
						}
				});
		}


  const fmtPct = v => (typeof v === 'number' ? Math.round(v) + '%' : v);
  const usdCompact = new Intl.NumberFormat('en-US', {
    style:'currency', currency:'USD', notation:'compact', maximumFractionDigits:1
  }).format;

  const netChart  = mkAnalyticsLine(document.getElementById('bm-net').getContext('2d'),  'Net Retention', fmtPct);
  const waChart   = mkAnalyticsLine(document.getElementById('bm-wa').getContext('2d'),   'W&A Premium',  v => usdCompact(v));
  const lossChart = mkAnalyticsLine(document.getElementById('bm-loss').getContext('2d'), '12MM Loss Ratio', fmtPct);

  async function loadTrends(bustCache = false) {
				const url = bustCache ? `/api/metrics-trend?t=${Date.now()}` : "/api/metrics-trend";
				const res = await fetch(url, { credentials: "same-origin", cache: "no-store" });
				const data = await res.json();

				// âœ… Helper: keep ONLY last 12 months
				function applyLast12(chart, series) {
						const labels = (series?.labels || []);
						const values = (series?.values || []);

						const start = Math.max(0, labels.length - 12);

						chart.data.labels = labels.slice(start);
						chart.data.datasets[0].data = values.slice(start);
						chart.update();
				}

				if (data["Net Retention"])     applyLast12(netChart,  data["Net Retention"]);
				if (data["W&A Premium"])       applyLast12(waChart,   data["W&A Premium"]);
				if (data["12MM Loss Ratio"])   applyLast12(lossChart, data["12MM Loss Ratio"]);
		}

  // ===== Quotes widget logic =====
  let QUOTES_PAGE = 1;
		let NB_PAGE = 1;

  async function refreshQuotes(page = QUOTES_PAGE) {
    QUOTES_PAGE = page;

    try {
      const r = await fetch(`/api/quotes/list?page=${page}`, { credentials: "same-origin" });
      const j = await r.json();

      const ul = document.getElementById("quotes-ul");
      if (!ul) return;
      ul.innerHTML = "";

      const fmtPT = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Los_Angeles",
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });

      (j.items || []).forEach(it => {
        const whenDate = it.uploaded_at ? new Date(it.uploaded_at) : null;
        const when = (whenDate && !isNaN(whenDate)) ? fmtPT.format(whenDate) : "â€”";
        const kb = Math.round((Number(it.file_size) || 0) / 1024);

        const li = document.createElement("li");
        li.style.margin = "4px 0";

        const a = document.createElement("a");
        a.href = `/quotes/view/${it.id}`;
        a.textContent = `${it.original_name} â€” ${when} (${kb} KB)`;
        a.target = "_blank";
        a.style.color = "#a8c7ff";

        li.appendChild(a);
        ul.appendChild(li);
      });

      if (!j.items || j.items.length === 0) {
        ul.innerHTML = "<li>No uploads yet.</li>";
      }

      const prevBtn = document.getElementById("quotes-prev");
      const nextBtn = document.getElementById("quotes-next");
      const pageLbl = document.getElementById("quotes-page");

      if (pageLbl) pageLbl.textContent = `Page ${j.page} of ${j.total_pages}`;
      if (prevBtn) {
        prevBtn.disabled = (j.page <= 1);
        prevBtn.onclick = () => refreshQuotes(j.page - 1);
      }
      if (nextBtn) {
        nextBtn.disabled = (j.page >= j.total_pages);
        nextBtn.onclick = () => refreshQuotes(j.page + 1);
      }
    } catch (e) {
      console.error(e);
    }
  }
		
		async function refreshNbUploads(page = NB_PAGE) {
    NB_PAGE = page;

    try {
      const r = await fetch(`/api/nb_uploads/list?page=${page}`, { credentials: "same-origin" });
      const j = await r.json();

      const ul = document.getElementById("nb-ul");
      if (!ul) return;
      ul.innerHTML = "";

      const fmtPT = new Intl.DateTimeFormat("en-US", {
        timeZone: "America/Los_Angeles",
        year: "numeric", month: "short", day: "2-digit",
        hour: "2-digit", minute: "2-digit"
      });

      (j.items || []).forEach(it => {
        const whenDate = it.uploaded_at ? new Date(it.uploaded_at) : null;
        const when = (whenDate && !isNaN(whenDate)) ? fmtPT.format(whenDate) : "â€”";
        const kb = Math.round((Number(it.file_size) || 0) / 1024);

        const li = document.createElement("li");
        li.style.margin = "4px 0";

        const a = document.createElement("a");
        a.href = `/nb_uploads/download/${it.id}`;
        a.textContent = `${it.original_name} â€” ${when} (${kb} KB)`;
        a.target = "_blank";
        a.style.color = "#a8c7ff";   // âœ… same color as quotes widget

        li.appendChild(a);
        ul.appendChild(li);
      });


      if (!j.items || j.items.length === 0) {
        ul.innerHTML = "<li>No NB uploads yet.</li>";
      }

      const prevBtn = document.getElementById("nb-prev");
      const nextBtn = document.getElementById("nb-next");
      const pageLbl = document.getElementById("nb-page");

      if (pageLbl) pageLbl.textContent = `Page ${j.page} of ${j.total_pages}`;
      if (prevBtn) {
        prevBtn.disabled = (j.page <= 1);
        prevBtn.onclick = () => refreshNbUploads(j.page - 1);
      }
      if (nextBtn) {
        nextBtn.disabled = (j.page >= j.total_pages);
        nextBtn.onclick = () => refreshNbUploads(j.page + 1);
      }
    } catch (e) {
      console.error(e);
    }
  }


  (function setupQuotesWidget(){
    const btn  = document.getElementById("quotes-upload-btn");
    const file = document.getElementById("quotes-file");
    if (!btn || !file) return;

    btn.addEventListener("click", () => file.click());
    file.addEventListener("change", async () => {
      if (!file.files || !file.files[0]) return;
      const fd = new FormData();
      fd.append("file", file.files[0]);
      try {
        const r = await fetch("/api/quotes/upload", { method: "POST", body: fd, credentials: "same-origin" });
        const j = await r.json();
        if (j.success) {
          file.value = "";
          await refreshQuotes(1);
        } else {
          alert(j.error || "Upload failed");
        }
      } catch (e) {
        console.error(e);
        alert("Upload failed");
      }
    });
  })();

  // âœ… DOM ready: just load data for this page
  window.addEventListener("DOMContentLoaded", () => {
    loadTrends();
    refreshQuotes(1);
    refreshNbUploads(1);  // ðŸ‘ˆ load NB uploads on page load
  });

</script>

{% endblock %}


